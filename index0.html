<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Grouped Layout</title>
        <style>
            /*@import url(../style.css);*/

            .node {
                stroke: #fff;
                stroke-width: 1.5px;
                cursor: move;
            }

            .group {
                stroke: #fff;
                stroke-width: 1.5px;
                cursor: move;
                opacity: 0.7;
            }

            .link {
                stroke: #7a4e4e;
                stroke-width: 3px;
                stroke-opacity: 1;
            }

            .label {
                fill: white;
                font-family: Verdana;
                font-size: 25px;
                text-anchor: middle;
                cursor: move;
            }

            #container{

                border: 2px solid #000;
                overflow: hidden; /*컨테이너밖으로 나가면 보이지 않도록*/

                margin: 0 auto;
            }

        </style>
        <script src="d3v4.js"></script>
        <script src="cola.min.js"></script>
    </head>
    <body>
        <h1>Display</h1>



        <input  type="button" value="night" onclick="
          if(this.value==='night'){
          document.querySelector('body').style.backgroundColor='black';
          document.querySelector('body').style.color='white';
          this.value='day'
        }
        else{
          document.querySelector('body').style.backgroundColor='white';
          document.querySelector('body').style.color='black';
          this.value='night'
        }">

        <div id="container"></div>

        <script>
            var docEl = document.documentElement,
                bodyEl = document.getElementsByTagName('body')[0];

            var width = window.innerWidth || docEl.clientWidth || bodyEl.clientWidth,
                height = window.innerHeight || docEl.clientHeight || bodyEl.clientHeight;

            var color = d3.scaleOrdinal(d3.schemeCategory20);

            var cola = cola.d3adaptor(d3)
                .flowLayout('y', 100)//위치 간격을 둠으로써 위에서 아래로 흐르고 수평수직문제사라짐
                .linkDistance(100)
                .avoidOverlaps(true) // node 겹침 방지
                .handleDisconnected(false)
                .size([width, height]);
///////////////////////////////////////////////////////////////1
            var container = d3.select("body").select("#container")
              .attr("width", width)
              .attr("height", height);

            var svgGroup1 = d3.select("body").select("#container").append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("viewbox", [0, 0, width, height]);

            var svg1 = svgGroup1.append("g"); //Zoom 떨림 방지를 위해 기존의 svg를 svgGroup화 하고 svg를 svgGroup의 child tag로 설정

            /* ------ Zoom ----- */

            //Zoom 이벤트
            var zoom = d3.zoom()
                .extent([[0,0], [width, height]])
                .scaleExtent([0.5,5])
                .on("zoom", zoomed);
            //Zoom 함수
            function zoomed(){
                svg1.attr("transform", d3.event.transform);
                console.log("zoomed");
            }
            //zoom 기능을 위해 call
            svgGroup1.call(zoom);

            /*------arrow--------*/

            svg1.append("svg:defs").selectAll("marker")
                .data(["end"])      // Different link/path types can be defined here
                .enter().append("svg:marker")    // This section adds in the arrows
                .attr("id", String)
                .attr("viewBox", "0 -5 10 10")
                .attr("refX", 20) //노드와 화살표 거리
                .attr("refY", 0)
                .attr("markerWidth", 10)
                .attr("markerHeight", 20)
                .attr("orient", "auto")
                .append("svg:path")
                .attr("d", "M0,-5L10,0L0,5");


            d3.json("severalFunctions.json", function (error, graph) {

                graph.groups.forEach(function (g) { g.padding = 0.01; });
                cola.nodes(graph.nodes)
                    .links(graph.links)
                    .groups(graph.groups)
                    .start(100, 0, 50, 50);

                var group = svg1.selectAll(".group") //group이라는 css클래스 전체를 선택
                    .data(graph.groups)//해당 클래스에 graph.group 데이터 매핑시킴
                    .enter().append("rect")
                    .attr("rx", 8).attr("ry", 8)
                    .attr("class", "group")
                    .style("fill", function (d, i) {
                      return color(i); });

                var link = svg1.selectAll(".link")
                    .data(graph.links)
                    .enter()
                    .append("line")
                /*    .append(function(d){
                      if(d.target==58) return "path";
                      else
                      return "line";
                    })*/
                    .attr("class", "link")
                    .attr("marker-end", "url(#end)")
                    .style("stroke", "#7a4e4e")
                    .style("stroke-opacity", 1);

                var pad = 3;

                var node = svg1.selectAll(".node")
                    .data(graph.nodes)
                    .enter().append("rect")
                    .attr("rx", 5).attr("ry", 5)
                    .attr("class", "node")
                    .style("fill", function (d) {
                      if(d.name=="END" || d.name=="START") return color(graph.groups.length+1);
                      else return color(graph.groups.length); })
                      .on("click", function(){
                          //d3.select(this).style("fill", #7a4e4e);
                          alert("on click");
                      });



                var label = svg1.selectAll(".label")
                    .data(graph.nodes)
                    .enter().append("text")
                    .attr("class", "label")
                    .text(function(d){
                        var nameSplit = d.name.split('~');
                        if(nameSplit[1]==null) return nameSplit[0]; //ex)main, IF, END ..
                            else return nameSplit[1]; //last class name::function name
                        })
                    .each(function (d) { //텍스트 박스에 맞춘 노드 사이즈 설정
                        var b = this.getBBox();
                        var extra = 20;
                        d.width = b.width + extra;
                        d.height = b.height + extra;
                    })
                    //.call(cola.drag);



                node.append("title")
                    .text(function (d) { return d.name; });

                cola.on("tick", function () { //setting location
                    link.attr("x1", function (d) { return d.source.x; })
                        .attr("y1", function (d) { return d.source.y; })
                        .attr("x2", function (d) { return d.target.x; })
                        .attr("y2", function (d) { return d.target.y; });

                    node.attr("x", function (d) { return d.x - d.width / 2; })
                        .attr("y", function (d) { return d.y - d.height / 2; })
                        .attr("width", function (d) { return d.bounds.width(); })
                        .attr("height", function (d) { return d.bounds.height(); });

                    group.attr("x", function (d) { return d.bounds.x; })
                         .attr("y", function (d) { return d.bounds.y; })
                         .attr("width", function (d) { return d.bounds.width(); })
                         .attr("height", function (d) { return d.bounds.height(); });

                    label.attr("x", function (d) { return d.x; })
                         .attr("y", function (d) {
                            var h = this.getBBox().height;// getbbox = text size box
                            return d.y + h/4;
                        });
                });
            });//////1


        ///////////////////////////////////////////////////////////2


                    var svgGroup2 = d3.select("body").select("#container").append("svg")
                        .attr("width", width)
                        .attr("height", height)
                        .attr("viewbox", [0, 0, width, height]);

                    var svg2 = svgGroup2.append("g"); //Zoom 떨림 방지를 위해 기존의 svg를 svgGroup화 하고 svg를 svgGroup의 child tag로 설정


                    /* ------ Zoom ----- */

                    //Zoom 이벤트
                    var zoom = d3.zoom()
                        .extent([[0,0], [width, height]])
                        .scaleExtent([0.5,5])
                        .on("zoom", zoomed);
                    //Zoom 함수
                    function zoomed(){
                        svg1.attr("transform", d3.event.transform);
                        console.log("zoomed");
                    }
                    //zoom 기능을 위해 call
                    svgGroup2.call(zoom);

                    /*------arrow--------*/

                    svg2.append("svg:defs").selectAll("marker")
                        .data(["end"])      // Different link/path types can be defined here
                        .enter().append("svg:marker")    // This section adds in the arrows
                        .attr("id", String)
                        .attr("viewBox", "0 -5 10 10")
                        .attr("refX", 20) //노드와 화살표 거리
                        .attr("refY", 0)
                        .attr("markerWidth", 10)
                        .attr("markerHeight", 20)
                        .attr("orient", "auto")
                        .append("svg:path")
                        .attr("d", "M0,-5L10,0L0,5");


                    d3.json("smallInsertHandler.json", function (error, graph) {

                        graph.groups.forEach(function (g) { g.padding = 0.01; });
                        cola.nodes(graph.nodes)
                            .links(graph.links)
                            .groups(graph.groups)
                            .start(100, 0, 50, 50);

                        var group = svg2.selectAll(".group") //group이라는 css클래스 전체를 선택
                            .data(graph.groups)//해당 클래스에 graph.group 데이터 매핑시킴
                            .enter().append("rect")
                            .attr("rx", 8).attr("ry", 8)
                            .attr("class", "group")
                            .style("fill", function (d, i) {
                              return color(i); });

                        var link = svg2.selectAll(".link")
                            .data(graph.links)
                            .enter()
                            .append("line")
                        /*    .append(function(d){
                              if(d.target==58) return "path";
                              else
                              return "line";
                            })*/
                            .attr("class", "link")
                            .attr("marker-end", "url(#end)")
                            .style("stroke", "#7a4e4e")
                            .style("stroke-opacity", 1);

                        var pad = 3;

                        var node = svg2.selectAll(".node")
                            .data(graph.nodes)
                            .enter().append("rect")
                            .attr("rx", 5).attr("ry", 5)
                            .attr("class", "node")
                            .style("fill", function (d) {
                              if(d.name=="END" || d.name=="START") return color(graph.groups.length+1);
                              else return color(graph.groups.length); })
                              .on("click", function(){
                                  //d3.select(this).style("fill", #7a4e4e);
                                  alert("on click");
                              });



                        var label = svg2.selectAll(".label")
                            .data(graph.nodes)
                            .enter().append("text")
                            .attr("class", "label")
                            .text(function(d){
                                var nameSplit = d.name.split('~');
                                if(nameSplit[1]==null) return nameSplit[0]; //ex)main, IF, END ..
                                    else return nameSplit[1]; //last class name::function name
                                })
                            .each(function (d) { //텍스트 박스에 맞춘 노드 사이즈 설정
                                var b = this.getBBox();
                                var extra = 20;
                                d.width = b.width + extra;
                                d.height = b.height + extra;
                            })
                            //.call(cola.drag);



                        node.append("title")
                            .text(function (d) { return d.name; });

                        cola.on("tick", function () { //setting location
                            link.attr("x1", function (d) { return d.source.x; })
                                .attr("y1", function (d) { return d.source.y; })
                                .attr("x2", function (d) { return d.target.x; })
                                .attr("y2", function (d) { return d.target.y; });

                            node.attr("x", function (d) { return d.x - d.width / 2; })
                                .attr("y", function (d) { return d.y - d.height / 2; })
                                .attr("width", function (d) { return d.bounds.width(); })
                                .attr("height", function (d) { return d.bounds.height(); });

                            group.attr("x", function (d) { return d.bounds.x; })
                                 .attr("y", function (d) { return d.bounds.y; })
                                 .attr("width", function (d) { return d.bounds.width(); })
                                 .attr("height", function (d) { return d.bounds.height(); });

                            label.attr("x", function (d) { return d.x; })
                                 .attr("y", function (d) {
                                    var h = this.getBBox().height;// getbbox = text size box
                                    return d.y + h/4;
                                });
                        });
                    });////2

        </script>
    </body>
</html>
